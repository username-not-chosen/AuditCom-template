<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Landing page - DigitalCom</title>
    <link rel="stylesheet" href="css/style.css" />
    <script src="src/main.js" type="module" defer></script>
    <meta property="og:title" content="Landing page - DigitalCom">
    <meta property="og:description" content="Un rapport complet sur les stratégies digitales des clubs romands.">
    <meta property="og:image" content="https://username-not-chosen.github.io/AuditCom-template/images/hero.webp">
    <meta property="og:url" content="https://username-not-chosen.github.io/AuditCom-template">
    <meta property="og:type" content="website">

</head>

<body>
    <!-- MODAL -->
    <div id="teamsModal" class="modal" aria-hidden="true">
        <div class="modal__backdrop" data-close-modal></div>

        <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="teamsModalTitle">
            <header class="modal__header">
                <h3 id="teamsModalTitle">Les équipes analysées</h3>
                <button class="modal__close" type="button" aria-label="Fermer" data-close-modal>×</button>
            </header>

            <div class="modal__content">
                <ul id="teamsModalList" class="teams-list"></ul>
            </div>
        </div>
    </div>

    <section id="hero">
        <h2>27 clubs analysés, des usages concrets révélés</h2>
        <h1>Le football romand à l’ère du digital</h1>
        <a href="#formulaire">Accéder aux résultats</a>
    </section>

    <section id="stats">
        <div class="stats-grid">
            <article class="stats-text stats-text--left">Synthèse<br />des chiffres</article>

            <!-- CARD 1 : OUI/NON vertical -->
            <article class="stat-card stat-card--chart" style="--value: 68">
                <p class="stat-card__title stat-card__title--preview">Clubs qui utilisent WordPress</p>

                <div class="bar2" role="img" aria-label="Répartition Oui/Non">
                    <div class="bar2__col">
                        <div class="bar2__plot">
                            <span class="bar2__bar bar2__bar--yes">
                                <span class="bar2__in bar2__in--yes"></span>
                            </span>
                        </div>
                        <div class="bar2__meta">
                            <span class="bar2__label">Oui</span>
                        </div>
                    </div>

                    <div class="bar2__col">
                        <div class="bar2__plot">
                            <span class="bar2__bar bar2__bar--no">
                                <span class="bar2__in bar2__in--no"></span>
                            </span>
                        </div>
                        <div class="bar2__meta">
                            <span class="bar2__label">Non</span>
                        </div>
                    </div>
                </div>
            </article>

            <article class="stat-card stat-card--chart stat-card--social">
                <p class="stat-card__title stat-card__title--preview">Clubs avec compte actif sur les réseaux sociaux
                </p>

                <div class="hstats" role="img" aria-label="YouTube 20%, TikTok 19%, X/Twitter 13%">
                    <div class="hstat" style="--v: 30">
                        <div class="hstat__label">Youtube</div>
                        <div class="hstat__bar">
                            <div class="hstat__fill"><span class="hstat__pct">20%</span></div>
                        </div>
                    </div>

                    <div class="hstat" style="--v: 25">
                        <div class="hstat__label">TikTok</div>
                        <div class="hstat__bar">
                            <div class="hstat__fill"><span class="hstat__pct">19%</span></div>
                        </div>
                    </div>

                    <div class="hstat" style="--v: 18">
                        <div class="hstat__label">X/Twitter</div>
                        <div class="hstat__bar">
                            <div class="hstat__fill"><span class="hstat__pct">13%</span></div>
                        </div>
                    </div>
                </div>
            </article>


            <article class="stat-card stat-card--chart stat-card--bigvalue" style="--value: 15">
                <p class="stat-card__title stat-card__title--preview">Clubs avec newsletter</p>
                <div class="stat-card__header"></div>
                <p class="stat-card__big">15%</p>
            </article>


            <article class="stat-card stat-card--chart stat-card--bigvalue" style="--value: 15">
                <p class="stat-card__title stat-card__title--preview">Clubs avec newsletter</p>
                <div class="stat-card__header"></div>
                <p class="stat-card__big">1/4</p>
            </article>

            <article class="stats-text stats-text--right">Extraits de<br />l’analyse complète</article>
        </div>
    </section>

    <section id="equipes">
        <h2>Les équipes analysées</h2>

        <div class="carousel">
            <div class="carousel__track" id="teamTrack">
                <section id="teamList" class="carousel__row"></section>
                <section class="carousel__row" id="teamListClone" aria-hidden="true"></section>
            </div>
        </div>

        <div id="container-btn-equipe">
            <a id="btn-equipes" href="#">
                <p>+</p>
                <span data-bind-global="count"></span>
                <p id="btn-suffix">équipes</p>
            </a>
        </div>
    </section>

    <section id="formulaire">
        <div id="form-left">
            <h2>Télécharger<br>le rapport</h2>
        </div>

        <div id="form-right">
            <form id="downloadForm" class="download__form">
                <label class="sr-only" for="lastName">Nom</label>
                <input id="lastName" type="text" name="lastName" placeholder="Nom" required />

                <label class="sr-only" for="firstName">Prénom</label>
                <input id="firstName" type="text" name="firstName" placeholder="Prénom" required />

                <label class="sr-only" for="email">Email</label>
                <input id="email" type="email" name="email" placeholder="Email" required />

                <div class="download__consent">
                    <input id="consent" type="checkbox" name="newsletterAgreement" />
                    <label for="consent">S’inscrire à la newsletter</label>
                </div>


                <p id="consentHint" class="consent-hint" aria-live="polite"></p>

                <button type="submit" class="download__btn" id="downloadBtn">
                    <span class="download__btnLabel">Télécharger</span>

                    <span class="download__btnLayer" aria-hidden="true">
                        <div id="messageContainer" class="download__messages"></div>
                    </span>
                </button>
            </form>
        </div>
    </section>

    <footer>
        <p>
            Projet académique – HEIG-VD Analyse de l’écosystème digital des clubs de football romands<br />
            Réalisé par Daria Beaumann et Mattia Morel – Ingénierie des médias© 2026
        </p>
    </footer>

    <script>
        // MODAL
        const btnEquipes = document.querySelector("#btn-equipes");
        const modal = document.querySelector("#teamsModal");
        const modalList = document.querySelector("#teamsModalList");

        function openModal() {
            document.body.style.overflow = "hidden";
            modalList.innerHTML = "";

            const cards = document.querySelectorAll("#teamList .team-card");
            cards.forEach((card) => {
                const img = card.querySelector("img");
                const nameEl = card.querySelector(".team-card__name");

                const li = document.createElement("li");
                li.className = "teams-list__item";

                const avatar = document.createElement("div");
                avatar.className = "teams-list__avatar";

                if (img && img.getAttribute("src")) {
                    const modalImg = document.createElement("img");
                    modalImg.src = img.src;
                    modalImg.alt = img.alt || "";
                    avatar.appendChild(modalImg);
                }

                const line = document.createElement("div");
                line.className = "teams-list__line";
                line.textContent = nameEl ? nameEl.textContent.trim() : "Équipe";

                li.appendChild(avatar);
                li.appendChild(line);
                modalList.appendChild(li);
            });

            modal.classList.add("is-open");
            modal.setAttribute("aria-hidden", "false");
        }

        function closeModal() {
            modal.classList.remove("is-open");
            modal.setAttribute("aria-hidden", "true");
            document.body.style.overflow = "";
        }

        btnEquipes?.addEventListener("click", (e) => {
            e.preventDefault();
            openModal();
        });

        modal?.addEventListener("click", (e) => {
            const target = e.target;
            if (target && target.hasAttribute("data-close-modal")) closeModal();
        });

        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape" && modal.classList.contains("is-open")) {
                closeModal();
            }
        });


        document.querySelectorAll(".stat-card--chart").forEach((card) => {
            const raw = getComputedStyle(card).getPropertyValue("--value").trim();
            const v = parseFloat(raw);

            const yesIn = card.querySelector(".bar2__in--yes");
            const noIn = card.querySelector(".bar2__in--no");

            if (yesIn && !Number.isNaN(v)) {
                const yes = Math.max(0, Math.min(100, v));
                const no = 100 - yes;
                yesIn.textContent = `${Math.round(yes)}%`;
                if (noIn) noIn.textContent = `${Math.round(no)}%`;
            }
        });


        const downloadBtn = document.querySelector("#downloadBtn");
        const msgContainer = document.querySelector("#messageContainer");
        const form = document.querySelector("#downloadForm");
        const consent = document.querySelector("#consent");
        const consentHint = document.querySelector("#consentHint");

        if (downloadBtn && msgContainer && form) {
            const label = downloadBtn.querySelector(".download__btnLabel");

            let rafId = null;
            let manualLoading = false;


            let wasLoading = false;
            let hadProgressDuringThisDownload = false;

            const setProgressPct = (pct) => {
                const safe = Math.max(0, Math.min(100, pct));
                downloadBtn.style.setProperty("--p", safe.toFixed(2));
            };


            const renderMessage = ({ type = "error", text = "", showProgress = false, pct = 0 } = {}) => {
                const safePct = Math.max(0, Math.min(100, pct));
                msgContainer.innerHTML = `
          <aside class="message ${type}">
            <p>${text}</p>
            <div class="progress-container" style="${showProgress ? "" : "display:none;"}">
              <progress class="progress-bar" value="${safePct}" max="100"></progress>
              <span class="progress-text">${showProgress ? `${Math.round(safePct)}%` : ""}</span>
            </div>
          </aside>
        `;
            };

            const resetButtonNow = () => {
                manualLoading = false;
                wasLoading = false;
                hadProgressDuringThisDownload = false;

                downloadBtn.classList.remove("is-loading");
                downloadBtn.disabled = false;
                downloadBtn.setAttribute("aria-busy", "false");

                stop();
                setProgressPct(0);
            };

            const getProgressInfo = () => {
                const progressEl = msgContainer.querySelector("progress.progress-bar");
                if (!progressEl) return { exists: false, pct: 0 };

                const max = Number(progressEl.max) || 100;
                const val = Number(progressEl.value) || 0;
                const pct = max > 0 ? (val / max) * 100 : 0;
                return { exists: true, pct };
            };

            const getInjectedMessageText = () => {
                const msg = msgContainer.querySelector(".message");
                return (msg?.textContent || "").trim().toLowerCase();
            };

            const computeState = () => {
                const msg = msgContainer.querySelector(".message");
                const txt = getInjectedMessageText();
                const { exists, pct } = getProgressInfo();


                const isError =
                    msg?.classList.contains("error") ||
                    txt.includes("erreur") ||
                    txt.includes("error") ||
                    txt.includes("échec") ||
                    txt.includes("echec");


                let isSuccess =
                    msg?.classList.contains("success") ||
                    txt.includes("terminé") ||
                    txt.includes("termine") ||
                    txt.includes("succès") ||
                    txt.includes("success");


                let isLoading =
                    !isError &&
                    !isSuccess &&
                    (manualLoading ||
                        (exists && pct < 100) ||
                        txt.includes("téléchargement") ||
                        txt.includes("telechargement") ||
                        txt.includes("download"));


                if (manualLoading && exists) hadProgressDuringThisDownload = true;


                if (
                    manualLoading &&
                    !isError &&
                    !isSuccess &&
                    wasLoading &&
                    hadProgressDuringThisDownload &&
                    (!exists || pct >= 100)
                ) {
                    isSuccess = true;
                    isLoading = false;
                }

                return { isLoading, isSuccess, isError, pct, hasProgress: exists };
            };

            const stop = () => {
                if (rafId) cancelAnimationFrame(rafId);
                rafId = null;
            };

            const tick = () => {
                const { isLoading, pct, hasProgress } = computeState();
                if (hasProgress) setProgressPct(pct);
                if (isLoading) rafId = requestAnimationFrame(tick);
            };


            form.addEventListener("submit", (e) => {

                if (consent && !consent.checked) {
                    e.preventDefault();
                    e.stopImmediatePropagation();

                    resetButtonNow();

                    if (consentHint) {
                        consentHint.textContent = "Pour télécharger le rapport, vous devez cocher la case newsletter.";
                    }


                    if (label) label.textContent = "Télécharger le rapport complet";


                    return;
                }


                if (consentHint) consentHint.textContent = "";


                manualLoading = true;
                wasLoading = true;
                hadProgressDuringThisDownload = false;

                requestAnimationFrame(() => {
                    downloadBtn.classList.add("is-loading");
                    downloadBtn.disabled = true;
                    downloadBtn.setAttribute("aria-busy", "true");
                    if (label) label.textContent = "Téléchargement...";

                    stop();
                    setProgressPct(0);
                    tick();
                });


                clearTimeout(downloadBtn._watchdog);
                downloadBtn._watchdog = setTimeout(() => {
                    const hasMsg = !!msgContainer.querySelector(".message");
                    const hasProg = !!msgContainer.querySelector("progress.progress-bar");

                    if (downloadBtn.classList.contains("is-loading") && !hasMsg && !hasProg) {
                        resetButtonNow();

                        renderMessage({
                            type: "error",
                            text: "Téléchargement interrompu. Réessayez ou vérifiez le formulaire.",
                            showProgress: false
                        });

                        if (label) label.textContent = "Erreur de téléchargement";
                    }
                }, 8000);
            }, true);


            consent?.addEventListener("change", () => {
                if (!consentHint) return;
                consentHint.textContent = consent.checked
                    ? ""
                    : "Pour télécharger le rapport, vous devez cocher la case newsletter.";
            });

            const syncButtonState = () => {
                const { isLoading, isSuccess, isError, pct, hasProgress } = computeState();
                const lockUntil = Number(downloadBtn.dataset.doneLockUntil || 0);
                if (lockUntil && Date.now() < lockUntil) return;

                wasLoading = isLoading || (manualLoading && hadProgressDuringThisDownload);

                // TEXTE
                if (label) {
                    if (isLoading) label.textContent = "Téléchargement...";
                    else if (isSuccess) label.textContent = "Téléchargement terminé !";
                    else if (isError) label.textContent = "Erreur de téléchargement";
                    else label.textContent = "Télécharger le rapport complet";
                }

                // ETAT VISUEL
                if (isLoading) {
                    downloadBtn.classList.add("is-loading");
                    downloadBtn.disabled = true;
                    downloadBtn.setAttribute("aria-busy", "true");
                    if (hasProgress) setProgressPct(pct);

                    stop();
                    tick();
                    return;
                }

                // FIN (succès ou erreur)
                manualLoading = false;
                downloadBtn.classList.remove("is-loading");
                downloadBtn.disabled = false;
                downloadBtn.setAttribute("aria-busy", "false");
                stop();

                if (isSuccess) {
                    const doneMs = 1200;

                    downloadBtn.dataset.doneLockUntil = String(Date.now() + doneMs);
                    if (label) label.textContent = "Téléchargement terminé !";

                    setProgressPct(100);
                    clearTimeout(downloadBtn._resetFillTimer);
                    downloadBtn._resetFillTimer = setTimeout(() => setProgressPct(0), 250);

                    clearTimeout(downloadBtn._doneTimer);
                    downloadBtn._doneTimer = setTimeout(() => {
                        if (label) label.textContent = "Télécharger le rapport complet";
                        delete downloadBtn.dataset.doneLockUntil;
                    }, doneMs);
                } else {
                    setProgressPct(0);
                }
            };

            const observer = new MutationObserver(syncButtonState);
            observer.observe(msgContainer, {
                childList: true,
                subtree: true,
                characterData: true,
                attributes: true,
                attributeFilter: ["class", "value", "max"],
            });

            syncButtonState();
        }

        // Stats: sur mobile, on ouvre/ferme au tap (au lieu de hover)
        (() => {
            const isTouch = window.matchMedia("(hover: none), (pointer: coarse)").matches;
            if (!isTouch) return;

            const cards = document.querySelectorAll(".stat-card--chart");

            const closeAll = (except = null) => {
                cards.forEach(c => {
                    if (c !== except) c.classList.remove("is-open");
                });
            };

            cards.forEach((card) => {
                // rend la carte "tappable" et accessible
                if (!card.hasAttribute("tabindex")) card.setAttribute("tabindex", "0");
                card.style.cursor = "pointer";

                card.addEventListener("click", (e) => {
                    e.stopPropagation();

                    const willOpen = !card.classList.contains("is-open");
                    closeAll(card);
                    card.classList.toggle("is-open", willOpen);
                });

                // optionnel: clavier (Enter/Espace)
                card.addEventListener("keydown", (e) => {
                    if (e.key === "Enter" || e.key === " ") {
                        e.preventDefault();
                        const willOpen = !card.classList.contains("is-open");
                        closeAll(card);
                        card.classList.toggle("is-open", willOpen);
                    }
                });
            });

            // tap hors carte => on ferme
            document.addEventListener("click", () => closeAll());
        })();

    </script>
</body>

</html>